variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

image:
  name: docker/compose

services:
  - docker:dind

stages:
  - build
  - test

before_script:
  - apk update
  - apk add bash git sed

build_rails_app:
  stage: build
  artifacts:
    paths:
      - rails_neutrino_app
      - tmp
  script:
    - bash ci-start.sh
    - bash main-build.sh

test_sqlite:
  stage: test
  script:
    - bash main-test.sh 'rails_test_sqlite'

test_postgres:
  stage: test
  script:
    - bash main-test.sh 'rails_test_postgres'

server_sqlite:
  stage: test
  script:
    - bash ci-server.sh 'rails_server_sqlite'

server_postgres:
  stage: test
  script:
    - bash ci-server.sh 'rails_server_postgres'
